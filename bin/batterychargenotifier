#!/usr/bin/bash

battery_device_path=$(upower -e | grep 'battery_BAT0')

function battery_info {
    battery_info=$(upower -i $battery_device_path)
    battery_info_output=$(echo "$battery_info" | grep "$1")
    battery_percentage=$(echo "$battery_info" | grep 'percentage' | awk '{print $NF}')
    battery_percentage=${battery_percentage:0:-1}
}

battery_info 'time to empty'

if [ "$(echo $battery_info_output | awk '{print $NF}')" = "minutes" ] && [ "$(echo "$(echo $battery_info_output | awk '{print $4}') <= 10" | bc )" = "1" ]; then
    while true; do
        if [ "$(echo $battery_info_output | awk '{print $NF}')" = "charging" ]; then
            notify-send.py "Low Battery" "Please connect the device to a charger" -a "Battery Status" -u critical -t 1 --replaces-process batterychargenotifier -i battery-100 --hint string:image-path:battery-010 &
            break
        else
            notify-send.py "Low Battery" "Please connect the device to a charger" -a "Battery Status" -u critical -t 0 --replaces-process batterychargenotifier -i battery-100 --hint string:image-path:battery-010 int:value:$battery_percentage &
        fi
        sleep 1
        dbus-send --print-reply --system --dest=org.freedesktop.UPower $battery_device_path "org.freedesktop.UPower.Device.Refresh"
        battery_info 'state'
    done
fi
